<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.6.39">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>12&nbsp; Redshift querying guide – ADRF Onboarding Handbook</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./dashboards.html" rel="next">
<link href="./support.html" rel="prev">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-e26003cea8cd680ca0c55a263523d882.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap-772502b33bd99f95aed036135c3afa56.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 3,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


</head>

<body class="nav-sidebar floating">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./appendix.html"><span class="chapter-number">12</span>&nbsp; <span class="chapter-title">Redshift querying guide</span></a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="Search" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header sidebar-header-stacked">
      <a href="./index.html" class="sidebar-logo-link">
      <img src="./images/cilogowht.png" alt="" class="sidebar-logo py-0 d-lg-inline d-none">
      </a>
    <div class="sidebar-title mb-0 py-0">
      <a href="./">ADRF Onboarding Handbook</a> 
        <div class="sidebar-tools-main">
    <a href="https://github.com/Coleridge-Initiative" title="" class="quarto-navigation-tool px-1" aria-label=""><i class="bi bi-github"></i></a>
</div>
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Preface</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./access.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Obtaining ADRF Access and Account Set Up</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./onboarding.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Onboarding Modules and Security Training</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./faq.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">ADRF - FAQs</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./dosanddonts.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Do’s and Don’ts For Discussing Data Inside the ADRF</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./using.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Accessing and Using Your Workspace</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./accessing.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Accessing Your Data</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./storing.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Storing Analytic Results</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./sharing.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Sharing Information within the ADRF</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./export.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Export guidelines</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./packages.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">Adding Additional Packages in R/Python</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./support.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">Support</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./appendix.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">12</span>&nbsp; <span class="chapter-title">Redshift querying guide</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./dashboards.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">13</span>&nbsp; <span class="chapter-title">Accessing ADRF Dashboards</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./references.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">References</span></a>
  </div>
</li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#sec-guide" id="toc-sec-guide" class="nav-link active" data-scroll-target="#sec-guide">Introduction</a></li>
  <li><a href="#data-access" id="toc-data-access" class="nav-link" data-scroll-target="#data-access"><strong>Data Access</strong></a>
  <ul class="collapse">
  <li><a href="#dbeaver" id="toc-dbeaver" class="nav-link" data-scroll-target="#dbeaver">DBeaver</a></li>
  <li><a href="#sas-connection" id="toc-sas-connection" class="nav-link" data-scroll-target="#sas-connection">SAS Connection</a></li>
  <li><a href="#r-connection" id="toc-r-connection" class="nav-link" data-scroll-target="#r-connection">R Connection</a></li>
  <li><a href="#python-connection" id="toc-python-connection" class="nav-link" data-scroll-target="#python-connection">Python Connection</a></li>
  <li><a href="#stata-connection" id="toc-stata-connection" class="nav-link" data-scroll-target="#stata-connection">Stata Connection</a></li>
  </ul></li>
  <li><a href="#redshift-query-guidelines-for-researchers" id="toc-redshift-query-guidelines-for-researchers" class="nav-link" data-scroll-target="#redshift-query-guidelines-for-researchers"><strong>Redshift Query Guidelines for Researchers</strong></a>
  <ul class="collapse">
  <li><a href="#do-and-dont-do-best-practices" id="toc-do-and-dont-do-best-practices" class="nav-link" data-scroll-target="#do-and-dont-do-best-practices"><strong><em>DO and DON’T DO BEST PRACTICES:</em></strong></a></li>
  <li><a href="#other-pointers-for-best-database-performance" id="toc-other-pointers-for-best-database-performance" class="nav-link" data-scroll-target="#other-pointers-for-best-database-performance"><strong><em>Other Pointers for best database performance</em></strong></a></li>
  <li><a href="#amazon-redshift-best-practices-for-from" id="toc-amazon-redshift-best-practices-for-from" class="nav-link" data-scroll-target="#amazon-redshift-best-practices-for-from"><strong>Amazon Redshift best practices for FROM</strong></a></li>
  <li><a href="#amazon-redshift-best-practices-for-where" id="toc-amazon-redshift-best-practices-for-where" class="nav-link" data-scroll-target="#amazon-redshift-best-practices-for-where"><strong>Amazon Redshift best practices for WHERE</strong></a></li>
  <li><a href="#amazon-redshift-best-practices-for-group-by" id="toc-amazon-redshift-best-practices-for-group-by" class="nav-link" data-scroll-target="#amazon-redshift-best-practices-for-group-by"><strong>Amazon Redshift best practices for GROUP BY</strong></a></li>
  <li><a href="#amazon-redshift-best-practices-for-having" id="toc-amazon-redshift-best-practices-for-having" class="nav-link" data-scroll-target="#amazon-redshift-best-practices-for-having"><strong>Amazon Redshift best practices for HAVING</strong></a></li>
  <li><a href="#amazon-redshift-best-practices-for-union" id="toc-amazon-redshift-best-practices-for-union" class="nav-link" data-scroll-target="#amazon-redshift-best-practices-for-union"><strong>Amazon Redshift best practices for UNION</strong></a></li>
  <li><a href="#amazon-redshift-best-practices-for-order-by" id="toc-amazon-redshift-best-practices-for-order-by" class="nav-link" data-scroll-target="#amazon-redshift-best-practices-for-order-by"><strong>Amazon Redshift best practices for ORDER BY</strong></a></li>
  <li><a href="#troubleshooting-queries" id="toc-troubleshooting-queries" class="nav-link" data-scroll-target="#troubleshooting-queries"><strong>Troubleshooting Queries</strong></a></li>
  </ul></li>
  <li><a href="#aws-sources" id="toc-aws-sources" class="nav-link" data-scroll-target="#aws-sources"><strong>AWS Sources</strong></a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title"><span class="chapter-number">12</span>&nbsp; <span class="chapter-title">Redshift querying guide</span></h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<section id="sec-guide" class="level2">
<h2 class="anchored" data-anchor-id="sec-guide">Introduction</h2>
<p>This document serves as an introduction to generating proficient Amazon Redshift queries. This is a generalized document meaning you will need to replace “schema_name” and “table_name” with the appropriate schema and table names used for your project.</p>
</section>
<section id="data-access" class="level2">
<h2 class="anchored" data-anchor-id="data-access"><strong>Data Access</strong></h2>
<p>The data is housed in Redshift. <strong>You need to replace the “user.name.project” with your project based username. The project based username is your user folder name in the</strong> <code>U:/</code> <strong>drive:</strong></p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/ap1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" alt="User folder"></p>
</figure>
</div>
<blockquote class="blockquote">
<p>Note: Your username will be different than in these examples.</p>
</blockquote>
<p>The password needed to access Redshift is the second password entered when logging into the ADRF as shown in the screen below:</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/ap2.png" class="img-fluid quarto-figure quarto-figure-center figure-img" alt="login"></p>
</figure>
</div>
<p>All data is stored under schemas in the <strong><em>projects</em></strong> database and are accessible by the following programs:</p>
<section id="dbeaver" class="level3">
<h3 class="anchored" data-anchor-id="dbeaver">DBeaver</h3>
<p>To establish a connection to Redshift in DBeaver, first double click on the server you wish to connect to. In the example below I’m connecting to <code>Redshift11_projects</code>. Then a window will appear asking for your Username and Password. This will be your user folder name and include <code>adrf\</code> before the username. Then click OK. You will now have access to your data stored on the <code>Redshift11_projects</code> server.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/ap3.png" class="img-fluid quarto-figure quarto-figure-center figure-img" alt="dbeaver project"></p>
</figure>
</div>
<p><strong>Creating Tables in PR/TR Schema</strong></p>
<p>When users create tables in their PR (Research Project) or TR (Training Project) schema, the table is initially permissioned to the user only. This is analogous to creating a document or file in your U drive: Only you have access to the newly created table.</p>
<p>If you want to allow all individuals in your project workspace to access the table in the PR/TR schema, you will need to grant permission to the table to the rest of the users who have access to the PR or TR schema.</p>
<p>You can do this by running the following code:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="kw">GRANT</span> <span class="kw">SELECT</span>, <span class="kw">UPDATE</span>, <span class="kw">DELETE</span>, <span class="kw">INSERT</span> <span class="kw">ON</span> <span class="kw">TABLE</span> schema_name.table_name <span class="kw">TO</span> <span class="kw">group</span> db_xxxxxx_rw;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<blockquote class="blockquote">
<p>Note: In the above code example replace <code>schma_name</code> with the <code>pr_</code> or <code>tr_</code> schema assigned to your workspace and replace <code>table_name</code> with the name of the table on which you want to grant access. Also, in the group name <code>db_xxxxxx_rw</code>, replace <code>xxxxxx</code> with your project code. This is the last 6 characters in your project based user name. This will start with either a <code>T</code> or a <code>P</code>.</p>
</blockquote>
<p>If you want to allow only a single user on your project to access the table, you will need to grant permission to that user. You can do this by running the following code:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="kw">GRANT</span> <span class="kw">SELECT</span>, <span class="kw">UPDATE</span>, <span class="kw">DELETE</span>, <span class="kw">INSERT</span> <span class="kw">ON</span> <span class="kw">TABLE</span> schema_name.table_name <span class="kw">to</span> <span class="ot">"IAM:first_name.last_name.project_code"</span>;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<blockquote class="blockquote">
<p>Note: In the above code example replace <code>schma_name</code> with the <code>pr_</code> or <code>tr_</code> schema assigned to your workspace and replace <code>table_name</code> with the name of the table on which you want to grant access. Also, in <code>"IAM:first_name.last_name.project_code"</code> update <code>first_name.last_name.project_code</code> with the user name to whom you want to grant access to.</p>
</blockquote>
<p>If you have any questions, please reach out to us at <a href="mailto:support@coleridgeinitiative.org">support@coleridgeinitiative.org</a></p>
<p>When connecting to the database using an ODBC connection, you need to use one of the following DSNs:</p>
<ul>
<li><p><strong>Redshift01_projects_DSN</strong></p></li>
<li><p><strong>Redshift11_projects_DSN</strong></p></li>
</ul>
<p>In the code examples below, the default DSN is <code>Redshift01_projects_DSN</code>.</p>
</section>
<section id="sas-connection" class="level3">
<h3 class="anchored" data-anchor-id="sas-connection">SAS Connection</h3>
<pre class="sas"><code>proc sql;
connect to odbc as my con
(datasrc=Redshift01_projects_DSN user=adrf\user.name.project password=password);
select * from connection to mycon
(select * form projects.schema.table);
disconnect from mycon;
quit;</code></pre>
</section>
<section id="r-connection" class="level3">
<h3 class="anchored" data-anchor-id="r-connection">R Connection</h3>
<section id="connecting-to-redshift11_projects-recommended" class="level4">
<h4 class="anchored" data-anchor-id="connecting-to-redshift11_projects-recommended">Connecting to Redshift11_projects (Recommended)</h4>
<blockquote class="blockquote">
<p>Note: You may need to install the packages <code>RJDBC</code> and <code>rstudioapi</code> first.</p>
</blockquote>
<div class="sourceCode" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(RJDBC)</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Create username</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>dbusr<span class="ot">=</span><span class="fu">paste</span>(<span class="st">"ADRF</span><span class="sc">\\</span><span class="st">"</span>, <span class="fu">Sys.getenv</span>(<span class="st">"USERNAME"</span>), <span class="at">sep=</span> <span class="st">''</span>)                                                                                </span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Database URL</span></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>url <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"jdbc:redshift:iam://adrf-redshift11.cdy8ch2udktk.us-gov-west-1.redshift.amazonaws.com:5439/projects;"</span>,</span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>              <span class="st">"loginToRp=urn:amazon:webservices:govcloud;"</span>,</span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>              <span class="st">"ssl=true;"</span>,</span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>              <span class="st">"AutoCreate=true;"</span>,</span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>              <span class="st">"idp_host=adfs.adrf.net;"</span>,</span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a>              <span class="st">"idp_port=443;"</span>,</span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a>              <span class="st">"ssl_insecure=true;"</span>,</span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a>              <span class="st">"plugin_name=com.amazon.redshift.plugin.AdfsCredentialsProvider"</span>)</span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a><span class="co"># Redshift JDBC Driver Setting</span></span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a>driver <span class="ot">&lt;-</span> <span class="fu">JDBC</span>(<span class="st">"com.amazon.redshift.jdbc42.Driver"</span>,</span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a>               <span class="at">classPath =</span> <span class="st">"C:</span><span class="sc">\\</span><span class="st">drivers</span><span class="sc">\\</span><span class="st">redshift_withsdk</span><span class="sc">\\</span><span class="st">redshift-jdbc42-2.1.0.12</span><span class="sc">\\</span><span class="st">redshift-jdbc42-2.1.0.12.jar"</span>,</span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true" tabindex="-1"></a>               <span class="at">identifier.quote=</span><span class="st">"`"</span>)</span>
<span id="cb4-20"><a href="#cb4-20" aria-hidden="true" tabindex="-1"></a>con <span class="ot">&lt;-</span> <span class="fu">dbConnect</span>(driver, url, dbusr, rstudioapi<span class="sc">::</span><span class="fu">askForPassword</span>())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="connecting-to-redshift11_projects-using-.renviron-file" class="level4">
<h4 class="anchored" data-anchor-id="connecting-to-redshift11_projects-using-.renviron-file">Connecting to Redshift11_projects using .Renviron File</h4>
<div class="sourceCode" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(RJDBC)</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>dbusr<span class="ot">=</span><span class="fu">Sys.getenv</span>(<span class="st">"DBUSER"</span>)                                                                                  </span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>dbpswd<span class="ot">=</span><span class="fu">Sys.getenv</span>(<span class="st">"DBPASSWD"</span>)</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Database URL</span></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>url <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"jdbc:redshift:iam://adrf-redshift11.cdy8ch2udktk.us-gov-west-1.redshift.amazonaws.com:5439/projects;"</span>,</span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a><span class="st">"loginToRp=urn:amazon:webservices:govcloud;"</span>,</span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a><span class="st">"ssl=true;"</span>,</span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a><span class="st">"AutoCreate=true;"</span>,</span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a><span class="st">"idp_host=adfs.adrf.net;"</span>,</span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a><span class="st">"idp_port=443;"</span>,</span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a><span class="st">"ssl_insecure=true;"</span>,</span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a><span class="st">"plugin_name=com.amazon.redshift.plugin.AdfsCredentialsProvider"</span>)</span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Redshift JDBC Driver Setting</span></span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a>driver <span class="ot">&lt;-</span> <span class="fu">JDBC</span>(<span class="st">"com.amazon.redshift.jdbc42.Driver"</span>,</span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a><span class="at">classPath =</span> <span class="st">"C:</span><span class="sc">\\</span><span class="st">drivers</span><span class="sc">\\</span><span class="st">redshift_withsdk</span><span class="sc">\\</span><span class="st">redshift-jdbc42-2.1.0.12</span><span class="sc">\\</span><span class="st">redshift-jdbc42-2.1.0.12.jar"</span>,</span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a><span class="at">identifier.quote=</span><span class="st">"`"</span>)</span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true" tabindex="-1"></a>conn <span class="ot">&lt;-</span> <span class="fu">dbConnect</span>(driver, url, dbusr, dbpswd)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><em>For the above code to work, please create a file name <strong>.Renviron</strong> in your user folder (user folder is something like i.e.&nbsp;u:\John.doe.p00002) And <strong>.Renviron file</strong> should contain the following:</em></p>
<div class="sourceCode" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>DBUSER<span class="ot">=</span><span class="st">'adrf\John.doe.p00002'</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>DBPASSWD<span class="ot">=</span><span class="st">'xxxxxxxxxxxx'</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><em>PLEASE replace user id and password with your project workspace specific user is and password.</em></p>
<p><em>This will ensure you don’t have your id and password in R code and then you can easily share your R code with others without sharing your ID and password.</em></p>
</section>
<section id="connecting-to-redshift01_projects-recommended" class="level4">
<h4 class="anchored" data-anchor-id="connecting-to-redshift01_projects-recommended">Connecting to Redshift01_projects (Recommended)</h4>
<blockquote class="blockquote">
<p>Note: You may need to install the packages <code>RJDBC</code> and <code>rstudioapi</code> first.</p>
</blockquote>
<div class="sourceCode" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(RJDBC)</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Create username</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>dbusr<span class="ot">=</span><span class="fu">paste</span>(<span class="st">"ADRF</span><span class="sc">\\</span><span class="st">"</span>, <span class="fu">Sys.getenv</span>(<span class="st">"USERNAME"</span>), <span class="at">sep=</span> <span class="st">''</span>)                                                                                </span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Database URL</span></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>url <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"jdbc:redshift:iam://adrf-redshift01.cdy8ch2udktk.us-gov-west-1.redshift.amazonaws.com:5439/projects;"</span>,</span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>              <span class="st">"loginToRp=urn:amazon:webservices:govcloud;"</span>,</span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>              <span class="st">"ssl=true;"</span>,</span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>              <span class="st">"AutoCreate=true;"</span>,</span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a>              <span class="st">"idp_host=adfs.adrf.net;"</span>,</span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a>              <span class="st">"idp_port=443;"</span>,</span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a>              <span class="st">"ssl_insecure=true;"</span>,</span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a>              <span class="st">"plugin_name=com.amazon.redshift.plugin.AdfsCredentialsProvider"</span>)</span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a><span class="co"># Redshift JDBC Driver Setting</span></span>
<span id="cb7-17"><a href="#cb7-17" aria-hidden="true" tabindex="-1"></a>driver <span class="ot">&lt;-</span> <span class="fu">JDBC</span>(<span class="st">"com.amazon.redshift.jdbc42.Driver"</span>,</span>
<span id="cb7-18"><a href="#cb7-18" aria-hidden="true" tabindex="-1"></a>               <span class="at">classPath =</span> <span class="st">"C:</span><span class="sc">\\</span><span class="st">drivers</span><span class="sc">\\</span><span class="st">redshift_withsdk</span><span class="sc">\\</span><span class="st">redshift-jdbc42-2.1.0.12</span><span class="sc">\\</span><span class="st">redshift-jdbc42-2.1.0.12.jar"</span>,</span>
<span id="cb7-19"><a href="#cb7-19" aria-hidden="true" tabindex="-1"></a>               <span class="at">identifier.quote=</span><span class="st">"`"</span>)</span>
<span id="cb7-20"><a href="#cb7-20" aria-hidden="true" tabindex="-1"></a>con <span class="ot">&lt;-</span> <span class="fu">dbConnect</span>(driver, url, dbusr, rstudioapi<span class="sc">::</span><span class="fu">askForPassword</span>())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="connecting-to-redshift01_projects-using-.renviron-file" class="level4">
<h4 class="anchored" data-anchor-id="connecting-to-redshift01_projects-using-.renviron-file">Connecting to Redshift01_projects using .Renviron File</h4>
<div class="sourceCode" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(RJDBC)</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>dbusr<span class="ot">=</span><span class="fu">Sys.getenv</span>(<span class="st">"DBUSER"</span>)                                                                    dbpswd<span class="ot">=</span><span class="fu">Sys.getenv</span>(<span class="st">"DBPASSWD"</span>)</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Database URL</span></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>url <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"jdbc:redshift:iam://adrf-redshift01.cdy8ch2udktk.us-gov-west-1.redshift.amazonaws.com:5439/projects;"</span>,</span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a><span class="st">"loginToRp=urn:amazon:webservices:govcloud;"</span>,</span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a><span class="st">"ssl=true;"</span>,</span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a><span class="st">"AutoCreate=true;"</span>,</span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a><span class="st">"idp_host=adfs.adrf.net;"</span>,</span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a><span class="st">"idp_port=443;"</span>,</span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a><span class="st">"ssl_insecure=true;"</span>,</span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a><span class="st">"plugin_name=com.amazon.redshift.plugin.AdfsCredentialsProvider"</span>)</span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Redshift JDBC Driver Setting</span></span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a>driver <span class="ot">&lt;-</span> <span class="fu">JDBC</span>(<span class="st">"com.amazon.redshift.jdbc42.Driver"</span>,</span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true" tabindex="-1"></a><span class="at">classPath =</span> <span class="st">"C:</span><span class="sc">\\</span><span class="st">drivers</span><span class="sc">\\</span><span class="st">redshift_withsdk</span><span class="sc">\\</span><span class="st">redshift-jdbc42-2.1.0.12</span><span class="sc">\\</span><span class="st">redshift-jdbc42-2.1.0.12.jar"</span>,</span>
<span id="cb8-17"><a href="#cb8-17" aria-hidden="true" tabindex="-1"></a><span class="at">identifier.quote=</span><span class="st">"`"</span>)</span>
<span id="cb8-18"><a href="#cb8-18" aria-hidden="true" tabindex="-1"></a>conn <span class="ot">&lt;-</span> <span class="fu">dbConnect</span>(driver, url, dbusr, dbpswd)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><em>For the above code to work, please create a file name <strong>.Renviron</strong> in your user folder (user folder is something like i.e.&nbsp;u:\John.doe.p00002) And <strong>.Renviron file</strong> should contain the following:</em></p>
<div class="sourceCode" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>DBUSER<span class="ot">=</span><span class="st">'adrf\John.doe.p00002'</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>DBPASSWD<span class="ot">=</span><span class="st">'xxxxxxxxxxxx'</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><em>PLEASE replace user id and password with your project workspace specific user is and password.</em></p>
<p><em>This will ensure you don’t have your id and password in R code and then you can easily share your R code with others without sharing your ID and password.</em></p>
<p><strong>Best practices for loading large amounts of data in R</strong></p>
</section>
<section id="sql-basics-with-r-programming" class="level4">
<h4 class="anchored" data-anchor-id="sql-basics-with-r-programming">SQL Basics with R Programming</h4>
<p>To ensure R can efficiently manage large amounts of data, please add the following lines of code to your R script before any packages are loaded:</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="fu">options</span>(<span class="at">java.parameters =</span> <span class="fu">c</span>(<span class="st">"-XX:+UseConcMarkSweepGC"</span>, <span class="st">"-Xmx8192m"</span>))</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a><span class="fu">gc</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><strong>Best practices for writing tables to Redshift</strong></p>
<p>When writing an R data frame to Redshift use the following code as an example:</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Note: replace the table_name with the name of the data frame you wish to write to Redshift</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>DBI<span class="sc">::</span><span class="fu">dbWriteTable</span>(<span class="at">conn =</span> conn, <span class="co">#name of the connection </span></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a><span class="at">name =</span> <span class="st">"schema_name.table_name"</span>, <span class="co">#name of table to save df to </span></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a><span class="at">value =</span> df_name, <span class="co">#name of df to write to Redshift </span></span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a><span class="at">overwrite =</span> <span class="cn">TRUE</span>) <span class="co">#if you want to overwrite a current table, otherwise FALSE</span></span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a>qry <span class="ot">&lt;-</span> <span class="st">"GRANT SELECT ON TABLE schema.table_name TO group &lt;group_name&gt;;"</span></span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a><span class="fu">dbSendUpdate</span>(conn,qry)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
</section>
<section id="python-connection" class="level3">
<h3 class="anchored" data-anchor-id="python-connection">Python Connection</h3>
<div class="sourceCode" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pyodbc</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>cnxn <span class="op">=</span> pyodbc.<span class="ex">connect</span>(<span class="st">'DSN=Redshift01_projects_DSN; UID=adrf\user.name.project; PWD=password'</span>)</span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> pd.read_sql(<span class="st">"SELECT * FROM projects.schema_name.table_name"</span>, cnxn)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="stata-connection" class="level3">
<h3 class="anchored" data-anchor-id="stata-connection">Stata Connection</h3>
<div class="sourceCode" id="cb13"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="kw">odbc</span> <span class="kw">load</span>, <span class="kw">exec</span>(<span class="st">"select * from PATH_TO_TABLE"</span>) <span class="kw">clear</span> dsn(<span class="st">"Redshift11_projects_DSN"</span>) user(<span class="st">"adrf\user.name.project"</span>) password(<span class="st">"password"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
</section>
<section id="redshift-query-guidelines-for-researchers" class="level2">
<h2 class="anchored" data-anchor-id="redshift-query-guidelines-for-researchers"><strong>Redshift Query Guidelines for Researchers</strong></h2>
<p><em>Developing your query.</em> Here’s an example workflow to follow when developing a query.</p>
<ol type="1">
<li><p>Study the column and table metadata, which is accessible via the table definition. Each table definition can be displayed by clicking on the [+] next the table name.</p></li>
<li><p>To get a feel for a table’s values, SELECT * from the tables you’re working with and LIMIT your results (Keep the LIMIT applied as you refine your columns) or use (e.g., select * from [table name] LIMIT 1000 )</p></li>
<li><p>Narrow down the columns to the minimal set required to answer your question.</p></li>
<li><p>Apply any filters to those columns.</p></li>
<li><p>If you need to aggregate data, aggregate a small number of rows</p></li>
<li><p>Once you have a query returning the results you need, look for sections of the query to save as a Common Table Expression (CTE) to encapsulate that logic.</p></li>
</ol>
<section id="do-and-dont-do-best-practices" class="level3">
<h3 class="anchored" data-anchor-id="do-and-dont-do-best-practices"><strong><em>DO and DON’T DO BEST PRACTICES:</em></strong></h3>
<section id="tip-1-use-select-columns-instead-of-select" class="level4">
<h4 class="anchored" data-anchor-id="tip-1-use-select-columns-instead-of-select"><strong>Tip 1: Use SELECT &lt;columns&gt; instead of SELECT *</strong></h4>
<p>Specify the columns in the SELECT clause instead of using SELECT *. The unnecessary columns place extra load on the database, which slows down not just the single Amazon Redshift, but the whole system.</p>
<p><strong>Inefficient</strong></p>
<p><code>SELECT * FROM projects.schema_name.table_name</code></p>
<p>This query fetches all the data stored in the table you choose which might not be required for a particular scenario.</p>
<p><strong>Efficient</strong></p>
<p><code>SELECT col_A, col_B, col_C FROM projects.schema_name.table_name</code></p>
</section>
<section id="tip-2-always-fetch-limited-data-and-target-accurate-results" class="level4">
<h4 class="anchored" data-anchor-id="tip-2-always-fetch-limited-data-and-target-accurate-results"><strong>Tip 2: Always fetch limited data and target accurate results</strong></h4>
<p>Lesser the data retrieved, the faster the query will run. Rather than applying too many filters on the client-side, filter the data as much as possible at the server. This limits the data being sent on the wire and you’ll be able to see the results much faster. In Amazon Redshift use <strong>LIMIT (###)</strong> qualifier at the end of the query to limit records.</p>
<p><code>SELECT col_A, col_B, col_C FROM projects.schema_name.table_name WHERE [apply some filter] LIMIT 1000</code></p>
</section>
<section id="tip-3-use-wildcard-characters-wisely" class="level4">
<h4 class="anchored" data-anchor-id="tip-3-use-wildcard-characters-wisely"><strong>Tip 3: Use wildcard characters wisely</strong></h4>
<p>Wildcard characters can be either used as a prefix or a suffix. Using leading wildcard (%) in combination with an ending wildcard will search all records for a match anywhere within the selected field.</p>
<p><strong>Inefficient</strong></p>
<p><code>Select col_A, col_B, col_C from projects.schema_name.table_name where col_A like '%BRO%'</code></p>
<p>This query will pull the expected results of<strong>Brown Sugar, Brownie, Brown Rice</strong>and so on. However, it will also pull unexpected results, such as<strong>Country Brown, Lamb with Broth, Cream of Broccoli</strong>.</p>
<p><strong>Efficient</strong></p>
<p><code>Select col_A, col_B, col_C from projects.schema_name.table_name where col_B like 'BRO%'.</code></p>
<p>This query will pull only the expected results of<strong>Brownie, Brown Rice, Brown Sugar</strong> and so on.</p>
</section>
<section id="tip-4-does-my-record-exist" class="level4">
<h4 class="anchored" data-anchor-id="tip-4-does-my-record-exist"><strong>Tip 4: Does My record exist?</strong></h4>
<p>Normally, developers use EXISTS() or COUNT() queries for matching a record entry. However, EXISTS() is more efficient as it will exit as soon as finding a matching record; whereas, COUNT() will scan the entire table even if the record is found in the first row.</p>
<p><strong>Efficient</strong></p>
<p><code>select col_A from projects.schema_name.table_name A where exists (select 1 from projects.schema_name.table_name B where A.col_A = B.col_A ) order by col_A;</code></p>
</section>
<section id="tip-5-avoidcorrelated-subqueries" class="level4">
<h4 class="anchored" data-anchor-id="tip-5-avoidcorrelated-subqueries"><strong>Tip 5: Avoidcorrelated subqueries</strong></h4>
<p>A correlated subquery depends on the parent or outer query. Since it executes row by row, it decreases the overall speed of the process.</p>
<p><strong>Inefficient</strong></p>
<p><code>SELECT col_A, col_B, (SELECT col_C FROM projects.schema_name.table_name_a WHERE col_C = c.rma LIMIT 1) AS new_name FROM projects.schema_name.table_name_b</code></p>
<p>Here, the problem is — the inner query is run for each row returned by the outer query. Going over the <strong>“table_name_b”</strong> table again and again for every row processed by the outer query creates process overhead. Instead, for Amazon Redshift query optimization, use JOIN to solve such problems.</p>
<p><strong>Efficient</strong></p>
<p><code>SELECT col_A, col_B, col_C FROM projects.schema_name.table_name c LEFT JOIN projects.schema_name.table_name co ON c.col_A = co.col_B</code></p>
</section>
<section id="tip-6-avoid-using-amazon-redshift-function-in-the-where-condition" class="level4">
<h4 class="anchored" data-anchor-id="tip-6-avoid-using-amazon-redshift-function-in-the-where-condition"><strong>Tip 6: Avoid using Amazon Redshift function in the where condition</strong></h4>
<p>Often developers use functions or methods with their Amazon Redshift queries.</p>
<p><strong>Inefficient</strong></p>
<p><code>SELECT col_A, col_B, col_C FROM projects.schema_name.table_name WHERE RIGHT(birth_date,4) = '1965' and LEFT(birth_date,2) = '07'</code></p>
<p>Note that even if<strong>birth_date</strong> has an index, the above query changes the WHERE clause in such a way that this index cannot be used anymore.</p>
<p><strong>Efficient</strong></p>
<p><code>SELECT col_A, col_B, col_C FROM projects.schema_name.table_name WHERE birth_date between '711965' and '7311965'</code></p>
</section>
<section id="tip-7-use-where-instead-of-having" class="level4">
<h4 class="anchored" data-anchor-id="tip-7-use-where-instead-of-having"><strong>Tip 7: Use WHERE instead of HAVING</strong></h4>
<p>HAVING clause filters the rows after all the rows are selected. It is just like a filter. Do not use the HAVING clause for any other purposes.It is useful when performing group bys and aggregations.</p>
</section>
<section id="tip-8-use-temp-tables-when-merging-large-data-sets" class="level4">
<h4 class="anchored" data-anchor-id="tip-8-use-temp-tables-when-merging-large-data-sets"><strong>Tip 8: Use temp tables when merging large data sets</strong></h4>
<p>Creating local temp tables will limit the number of records in large table joins and merges. Instead of performing large table joins, one can break out the analysis by performing the analysis in two steps: 1) create a temp table with limiting criteria to create a smaller / filtered result set. 2) join the temp table to the second large table to limit the number of records being fetched and to speed up the query. This is especially useful when there are no indexes on the join columns.</p>
<p><strong>Inefficient</strong></p>
<p><code>SELECT col_A, col_B, sum(col_C) total FROM projects.schema_name.table_name pd INNER JOIN projects.schema_name.table_name st ON pd.col_A=st.col_B WHERE pd.col_C like 'DOG%' GROUP BY pd.col_A, pd.col_B, pd.col_C</code></p>
<p>Note that even if joining column <strong>col_A</strong> has an index, the col_B column does not. In addition, because the size of some tables can be large, one should limit the size of the join table by first building a smaller filtered #temp table then performing the table joins.</p>
<p><strong>Efficient</strong></p>
<p><code>SET search_path = schema_name; -- this statement sets the default schema/database to projects.schema_name</code></p>
<p><strong>Step 1:</strong></p>
<p><code>CREATE TEMP TABLE temp_table (</code></p>
<p><code>col_A varchar(14),</code></p>
<p><code>col_B varchar(178),</code></p>
<p><code>col_C varchar(4) );</code></p>
<p><strong>Step 2:</strong></p>
<p><code>INSERT INTO temp_table SELECT col_A, col_B, col_C</code></p>
<p><code>FROM projects.schema_name.table_name WHERE col_B like 'CAT%';</code></p>
<p><strong>Step 3:</strong></p>
<p><code>SELECT pd.col_A, pd.col_B, pd.col_C, sum(col_C) as total FROM temp_table pd INNER JOIN projects.schema_name.table_name st ON pd.col_A=st.col_B GROUP BY pd.col_A, pd.col_B, pd.col_C;</code></p>
<p><code>DROP TABLE temp_table;</code></p>
<p>Note always drop the temp table after the analysis is complete to release data from physical memory.</p>
</section>
</section>
<section id="other-pointers-for-best-database-performance" class="level3">
<h3 class="anchored" data-anchor-id="other-pointers-for-best-database-performance"><strong><em>Other Pointers for best database performance</em></strong></h3>
<p><strong><em>SELECT columns, not stars.</em></strong> Specify the columns you’d like to include in the results (though it’s fine to use * when first exploring tables — just remember to LIMIT your results).</p>
<p><strong><em>Avoid using SELECT DISTINCT</em></strong>. SELECT DISTINCT command in Amazon Redshift used for fetching unique results and remove duplicate rows in the relation. To achieve this task, it basically groups together related rows and then removes them. GROUP BY operation is a costly operation. To fetch distinct rows and remove duplicate rows, use more attributes in the SELECT operation.</p>
<p><strong><em>Inner joins vs WHERE clause.</em></strong> Use inner join for merging two or more tables rather than using the WHERE clause. WHERE clause creates the CROSS join/ CARTESIAN product for merging tables. CARTESIAN product of two tables takes a lot of time.</p>
<p><strong><em>IN versus EXISTS.</em></strong> IN operator is costlier than EXISTS in terms of scans especially when the result of the subquery is a large dataset. We should try to use EXISTS rather than using IN for fetching results with a subquery.</p>
<p><strong>Avoid</strong></p>
<p><code>SELECT col_A , col_B, col_C</code></p>
<p><code>FROM projects.schema_name.table_name</code></p>
<p><code>WHERE col_A IN</code></p>
<p><code>(SELECT col_B FROM projects.schema_name.table_name WHERE col_B = 'DOG')</code></p>
<p><strong>Prefer</strong></p>
<p><code>SELECT col_A , col_B, col_C</code></p>
<p><code>FROM projects.schema_name.table_name</code></p>
<p><code>WHERE EXISTS</code></p>
<p><code>(SELECT col_A FROM projects.schema_name.table_name b WHERE</code></p>
<p><code>a.col_A = b.col_B and b.col_B = 'DOG')</code></p>
<p>Query optimizers can change the order of the following list, but this general lifecycle of a Amazon Redshift query is good to keep in mind when writing Amazon Redshift.</p>
<ol type="1">
<li><p><strong>FROM</strong> (and JOIN) get(s) the tables referenced in the query.</p></li>
<li><p><strong>WHERE</strong> filters data.</p></li>
<li><p><strong>GROUP BY</strong> aggregates data.</p></li>
<li><p><strong>HAVING</strong> filters out aggregated data that doesn’t meet the criteria.</p></li>
<li><p><strong>SELECT</strong> grabs the columns (then deduplicates rows if DISTINCT is invoked).</p></li>
<li><p><strong>UNION</strong> merges the selected data into a result set.</p></li>
<li><p><strong>ORDER BY</strong> sorts the results.</p></li>
</ol>
</section>
<section id="amazon-redshift-best-practices-for-from" class="level3">
<h3 class="anchored" data-anchor-id="amazon-redshift-best-practices-for-from"><strong>Amazon Redshift best practices for FROM</strong></h3>
<p><em>Join tables using the ON keyword.</em> Although it’s possible to “join” two tables using a WHERE clause, use an explicit JOIN. The JOIN + ON syntax distinguishes joins from WHERE clauses intended to filter the results.</p>
<p><code>SET search_path = schema_name;</code>– this statement sets the default schema/database to projects.schema_name</p>
<p><code>SELECT A.col_A , B.col_B, B.col_C</code></p>
<p><code>FROM projects.schema_name.table_name as A</code></p>
<p><code>JOIN projects.schema_name.table_name B ON A.col_A = B.col_B</code></p>
<p><em>Alias multiple tables.</em> When querying multiple tables, use aliases, and employ those aliases in your select statement, so the database (and your reader) doesn’t need to parse which column belongs to which table.</p>
<p><strong>Avoid</strong></p>
<p><code>SET search_path = schema_name;</code>– this statement sets the default schema/database to projects.schema_name</p>
<p><code>SELECT col_A , col_B, col_C</code></p>
<p><code>FROM dbo.table_name as A</code></p>
<p><code>LEFT JOIN dbo.table_name as B ON A.col_A = B.col_B</code></p>
<p><strong>Prefer</strong></p>
<p><code>SET search_path = schema_name;</code>– this statement sets the default schema/database to projects.schema_name</p>
<p><code>SELECT A.col_A , B.col_B, B.col_C</code></p>
<p><code>FROM dbo.table_name as A</code></p>
<p><code>LEFT JOIN dbo.table_name as B</code></p>
<p><code>A.col_A = B.col_B</code></p>
</section>
<section id="amazon-redshift-best-practices-for-where" class="level3">
<h3 class="anchored" data-anchor-id="amazon-redshift-best-practices-for-where"><strong>Amazon Redshift best practices for WHERE</strong></h3>
<p><em>Filter with WHERE before HAVING.</em> Use a WHERE clause to filter superfluous rows, so you don’t have to compute those values in the first place. Only after removing irrelevant rows, and after aggregating those rows and grouping them, include a HAVING clause to filter out aggregates.</p>
<p><em>Avoid functions on columns in WHERE clauses.</em> Using a function on a column in a WHERE clause can really slow down your query, as the function prevents the database from using an index to speed up the query. Instead of using the index to skip to the relevant rows, the function on the column forces the database to run the function on each row of the table. The concatenation operator || is also a function, so don’t try to concat strings to filter multiple columns. Prefer multiple conditions instead:</p>
<p><strong>Avoid</strong></p>
<p><code>SELECT col_A, col_B, col_C FROM projects.schema_name.table_name</code></p>
<p><code>WHERE concat(col_A, col_B) = 'REGULARCOFFEE'</code></p>
<p><strong>Prefer</strong></p>
<p><code>SELECT col_A, col_B, col_C FROM projects.schema_name.table_name</code></p>
<p><code>WHERE col_A ='REGULAR' and col_B = 'COFFEE'</code></p>
</section>
<section id="amazon-redshift-best-practices-for-group-by" class="level3">
<h3 class="anchored" data-anchor-id="amazon-redshift-best-practices-for-group-by"><strong>Amazon Redshift best practices for GROUP BY</strong></h3>
<p><em>Order multiple groupings by descending cardinality.</em> Where possible, GROUP BY columns in order of descending cardinality. That is, group by columns with more unique values first (like IDs or phone numbers) before grouping by columns with fewer distinct values (like state or gender).</p>
</section>
<section id="amazon-redshift-best-practices-for-having" class="level3">
<h3 class="anchored" data-anchor-id="amazon-redshift-best-practices-for-having"><strong>Amazon Redshift best practices for HAVING</strong></h3>
<p><em>Only use HAVING for filtering aggregates.</em> Before HAVING, filter out values using a WHERE clause before aggregating and grouping those values.</p>
<p><code>SELECT col_A, sum(col_B) as total_amt</code></p>
<p><code>FROM projects.schema_name.table_name</code></p>
<p><code>WHERE col_C = 1617 and col_A='key'</code></p>
<p><code>GROUP BY col_A</code></p>
<p><code>HAVING sum(col_D)&gt; 0</code></p>
</section>
<section id="amazon-redshift-best-practices-for-union" class="level3">
<h3 class="anchored" data-anchor-id="amazon-redshift-best-practices-for-union"><strong>Amazon Redshift best practices for UNION</strong></h3>
<p><em>Prefer UNION All to UNION.</em> If duplicates are not an issue, UNION ALL won’t discard them, and since UNION ALL isn’t tasked with removing duplicates, the query will be more efficient</p>
</section>
<section id="amazon-redshift-best-practices-for-order-by" class="level3">
<h3 class="anchored" data-anchor-id="amazon-redshift-best-practices-for-order-by"><strong>Amazon Redshift best practices for ORDER BY</strong></h3>
<p><em>Avoid sorting where possible, especially in subqueries</em>. If you must sort, make sure your subqueries are not needlessly sorting data.</p>
<p><strong>Avoid</strong></p>
<p><code>SELECT col_A, col_B, col_C</code></p>
<p><code>FROM projects.schema_name.table_name</code></p>
<p><code>WHERE col_B IN</code></p>
<p><code>(SELECT col_A FROM projects.schema_name.table_name</code></p>
<p><code>WHERE col_C = 534905 ORDER BY col_B);</code></p>
<p><strong>Prefer</strong></p>
<p><code>SELECT col_A, col_B, col_C</code></p>
<p><code>FROM projects.schema_name.table_name</code></p>
<p><code>WHERE col_A IN</code></p>
<p><code>(SELECT col_B FROM projects.schema_name.table_name</code></p>
<p><code>WHERE col_C = 534905);</code></p>
</section>
<section id="troubleshooting-queries" class="level3">
<h3 class="anchored" data-anchor-id="troubleshooting-queries"><strong>Troubleshooting Queries</strong></h3>
<p>There are several metrics for calculating the cost of the query in terms of storage, time, CPU utilization. <em>However, these metrics require DBA permissions to execute.</em> Follow up with ADRF support to get additional assistance.</p>
<p><strong>Using the SVL_QUERY_SUMMARY view:</strong> To analyze query summary information by stream, do the following:</p>
<p><strong>Step 1:</strong> <code>select query, elapsed, substring from svl_qlog order by query desc limit 5;</code></p>
<p><strong>Step 2:</strong> <code>select * from svl_query_summary where query = MyQueryID order by stm, seg, step;</code></p>
<p><strong><em>Execution Plan:</em></strong> Lastly, an execution plan is a detailed step-by-step processing plan used by the optimizer to fetch the rows. It can be enabled in the database using the following procedure:</p>
<ol type="1">
<li><p>Click on SQL Editor in the menu bar.</p></li>
<li><p>Click on Explain Execution Plan.</p></li>
</ol>
<p>It helps to analyze the major phases in the execution of a query. We can also find out which part of the execution is taking more time and optimize that sub-part. The execution plan shows which tables were accessed, what index scans were performed for fetching the data. If joins are present it shows how these tables were merged. Further, we can see a more detailed analysis view of each sub-operation performed during query execution.</p>
</section>
</section>
<section id="aws-sources" class="level2">
<h2 class="anchored" data-anchor-id="aws-sources"><strong>AWS Sources</strong></h2>
<p><a href="https://docs.aws.amazon.com/redshift/latest/dg/c_designing-queries-best-practices.html">Amazon Redshift best practices for designing queries - Amazon Redshift</a></p>
<p><a href="https://docs.aws.amazon.com/redshift/latest/dg/queries-troubleshooting.html">Troubleshooting queries - Amazon Redshift</a></p>
<p><a href="https://docs.aws.amazon.com/redshift/latest/dg/c_redshift-and-postgres-sql.html">Amazon Redshift and PostgreSQL - Amazon Redshift</a></p>
<p><a href="https://docs.aws.amazon.com/redshift/latest/dg/using-SVL-Query-Summary.html">Using the SVL_QUERY_SUMMARY view - Amazon Redshift</a></p>
<p><strong>Python:</strong></p>
<p><a href="https://docs.aws.amazon.com/redshift/latest/mgmt/python-connect-examples.html">Examples of using the Amazon Redshift Python connector - Amazon Redshift</a></p>
<p><strong>R:</strong></p>
<p><a href="https://aws.amazon.com/blogs/big-data/connecting-r-with-amazon-redshift/">Examples of using R with Amazon Redshift</a></p>
<p><strong>ODBC configuration (for SAS and Stata):</strong></p>
<p><a href="https://docs.aws.amazon.com/redshift/latest/mgmt/odbc20-install.html">Configuring a connection for ODBC driver version 2.x for Amazon Redshift - Amazon Redshift</a></p>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="./support.html" class="pagination-link" aria-label="Support">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">Support</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./dashboards.html" class="pagination-link" aria-label="Accessing ADRF Dashboards">
        <span class="nav-page-text"><span class="chapter-number">13</span>&nbsp; <span class="chapter-title">Accessing ADRF Dashboards</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->




</body></html>